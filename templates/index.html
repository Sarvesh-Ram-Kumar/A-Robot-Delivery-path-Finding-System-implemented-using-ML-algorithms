<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Warehouse Simulator</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 26px;
      color: #2c3e50;
    }

    #controls {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #3498db;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    button:hover {
      background: #2980b9;
    }

    #main {
      display: grid;
      grid-template-columns: 45% 35% 15%;
      gap: 20px;
      align-items: flex-start;
    }

    /* GRID PANEL */
    #grid {
      display: grid;
      grid-template-columns: repeat(10, 50px);
      grid-template-rows: repeat(10, 50px);
      gap: 2px;
      justify-content: center;
      background: #eaeaea;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .cell {
      width: 50px;
      height:50px;
      border: 1px solid #ddd;
      background-size: cover, contain;
      background-position: center, center;
      background-repeat: no-repeat, no-repeat;
      border-radius: 4px;
    }

    /* INFO + MATRIX STYLING */
    h3 {
      margin: 12px 0 6px;
      font-size: 16px;
      color: #34495e;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }

    .box {
      background: #fff;
      padding: 10px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 6px;
      max-height: 180px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    #matrix-output, #path-output {
      font-family: monospace;
      background: #fff;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    #path-output {
      max-height: 200px;
      overflow-y: auto;
    }

    #charge-level {
      font-size: 16px;
      font-weight: bold;
      color: #27ae60;
    }
  </style>
</head>
<body>

  <h2>Warehouse Grid Simulator</h2>

  <div id="controls">
    <button onclick="setMode('wall')">Wall</button>
    <button onclick="setMode('package')">Package</button>
    <button onclick="setMode('shelf')">Shelf</button>
    <button onclick="setMode('start')">Robot</button>
    <button onclick="setMode('trap')">Broken Floor</button>
    <button onclick="setMode('charger')">Charger</button>
    <button onclick="startTraining()">Start Training</button>
    <button onclick="replayPath()">Replay</button>
  </div>

  <div id="main">
    <!-- Left: Grid -->
    <div id="grid"></div>

    <!-- Middle: Info -->
    <div>
      <h3>Charge Level</h3>
      <p id="charge-level">100%</p>

      <h3>Delivery Log</h3>
      <div id="delivery-log" class="box"></div>

      <h3>Final Path</h3>
      <div id="path-output"></div>
    </div>

    <!-- Right: Matrix -->
    <div>
      <h3>Grid Matrix</h3>
      <div id="matrix-output"></div>
    </div>
  </div>

  <script>
    const gridSize = 10;
    const grid = document.getElementById('grid');
    let mode = 'wall';
    let lastPath = [];
    const gridMatrix = Array.from({ length: gridSize }, () => Array(gridSize).fill(0));

    const icons = {
      wall: '../static/images/wall.png',
      package: '../static/images/package.png',
      shelf: '../static/images/shelf.png',
      start: '../static/images/robot.png',
      robot: '../static/images/robot.png',
      broken: '../static/images/brokenfloor.jpg',
      charger: '../static/images/charger.jpeg',
      floor: '../static/images/floor.jpeg',
      tick: '../static/images/tick.png'
    };

    function setMode(newMode) { mode = newMode; }

    // build grid
    for (let i = 0; i < gridSize * gridSize; i++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');
      const row = Math.floor(i / gridSize);
      const col = i % gridSize;
      cell.dataset.row = row;
      cell.dataset.col = col;
      cell.style.backgroundImage = `url('${icons.floor}')`;

      cell.addEventListener('click', () => {
        const r = parseInt(cell.dataset.row);
        const c = parseInt(cell.dataset.col);

        if (mode === 'start') {
          document.querySelectorAll('.cell').forEach(cel => {
            if (cel.style.backgroundImage.includes('robot.png')) {
              cel.style.backgroundImage = `url('${icons.floor}')`;
              const ri = parseInt(cel.dataset.row);
              const ci = parseInt(cel.dataset.col);
              gridMatrix[ri][ci] = 0;
            }
          });
        }

        if (mode === 'wall') {
          gridMatrix[r][c] = 1;
          cell.style.backgroundImage = `url('${icons.wall}'), url('${icons.floor}')`;
        } else if (mode === 'package') {
          gridMatrix[r][c] = 2;
          cell.style.backgroundImage = `url('${icons.package}'), url('${icons.floor}')`;
        } else if (mode === 'shelf') {
          gridMatrix[r][c] = 3;
          cell.style.backgroundImage = `url('${icons.shelf}'), url('${icons.floor}')`;
        } else if (mode === 'start') {
          gridMatrix[r][c] = 4;
          cell.style.backgroundImage = `url('${icons.start}'), url('${icons.floor}')`;
        } else if (mode === 'charger') {
          gridMatrix[r][c] = 5;
          cell.style.backgroundImage = `url('${icons.charger}'), url('${icons.floor}')`;
        } else if (mode === 'trap') {
          gridMatrix[r][c] = 6;
          cell.style.backgroundImage = `url('${icons.broken}')`;
        }
      });

      grid.appendChild(cell);
    }

    function startTraining() {
      renderMatrix();

      fetch('/train', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ grid: gridMatrix })
      })
      .then(res => res.json())
      .then(data => {
        // update charge level correctly
        let chargeElement = document.getElementById("charge-level");
        if (data.final_charge !== undefined) {
          chargeElement.innerText = data.final_charge + "%";
        }

        document.getElementById("delivery-log").innerText = data.delivery_log.join("\n");

        renderPath(data.path);
        lastPath=data.path;
        animatePath(data.path);
      })
      .catch(err => {
        console.error("Error fetching training data:", err);
      });
    }

    function renderMatrix() {
      let out = "";
      for (let r = 0; r < gridSize; r++) {
        out += gridMatrix[r].join(" ") + "\n";
      }
      document.getElementById("matrix-output").innerText = out;
    }

    function renderPath(path) {
      let formatted = "";
      for (let i = 0; i < path.length; i++) {
        formatted += `[${path[i][0]}, ${path[i][1]}] `;
        if ((i + 1) % 10 === 0) formatted += "\n";
      }
      document.getElementById("path-output").innerText = formatted;
    }

    function placeTick(x, y) {
      const cellIndex = x * gridSize + y;
      const cell = grid.children[cellIndex];
      cell.style.backgroundImage = `url('${icons.tick}'), ${cell.style.backgroundImage}`;
    }

    function replayPath() {
      if (lastPath.length === 0) {
        alert("No path to replay yet!");
        return;
      }
      animatePath(lastPath);
    }

    function animatePath(path) {
      let i = 0;
      const delay = 300;

      function step() {
        if (i >= path.length) return;

        const [x, y] = path[i];
        const cellIndex = x * gridSize + y;
        const cell = grid.children[cellIndex];
        const cellType = gridMatrix[x][y];
        cell.style.backgroundImage = `url('${icons.robot}'), ${getImageByValue(cellType)}`;

        // âœ… Place tick when robot arrives on package or shelf
        if (cellType === 2 || cellType === 3) {
          placeTick(x, y);
        }

        if (i > 0) {
          const [px, py] = path[i - 1];
          const prev = grid.children[px * gridSize + py];
          const prevType = gridMatrix[px][py];
          prev.style.backgroundImage = getImageByValue(prevType);
        }

        i++;
        setTimeout(step, delay);
      }

      function getImageByValue(value) {
        if (value === 2) return `url('${icons.package}'), url('${icons.floor}')`;
        if (value === 3) return `url('${icons.shelf}'), url('${icons.floor}')`;
        if (value === 4) return `url('${icons.start}'), url('${icons.floor}')`;
        if (value === 5) return `url('${icons.charger}'), url('${icons.floor}')`;
        if (value === 1) return `url('${icons.wall}'), url('${icons.floor}')`;
        return `url('${icons.floor}')`;
      }

      step();
    }

  </script>
</body>
</html>
